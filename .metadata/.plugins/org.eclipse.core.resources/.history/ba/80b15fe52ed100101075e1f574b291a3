package wwa;

public class SharedWarehouseState {

    private int apples;
    private int oranges;

    // manual lock state (tutorial style)
    private boolean accessing = false;    // true if a thread has the lock
    private int threadsWaiting = 0;       // how many are waiting

    public SharedWarehouseState(int initialApples, int initialOranges) {
        this.apples = initialApples;
        this.oranges = initialOranges;
    }

    // ========= LOCKING METHODS (like SharedActionState) =========

    private synchronized void acquireLock() {
        Thread me = Thread.currentThread();
        threadsWaiting++;
        while (accessing) {
            try {
                // wait until the resource is free
                wait();
            } catch (InterruptedException e) {
                // ignore
            }
        }
        // this thread can now access the shared state
        threadsWaiting--;
        accessing = true;
    }

    private synchronized void releaseLock() {
        // free the resource and notify others
        accessing = false;
        notifyAll();
    }

    // ========= WAREHOUSE OPERATIONS =========

    public String checkStock() {
        acquireLock();
        try {
            return String.format("STOCK,apples=%d,oranges=%d", apples, oranges);
        } finally {
            releaseLock();
        }
    }

    public String buyApples(int number) {
        acquireLock();
        try {
            if (number <= 0) {
                return "ERROR,Buy_apples value must be positive";
            }
            if (number > apples) {
                return String.format("ERROR,Not enough apples in stock (have %d)", apples);
            }
            apples -= number;
            return String.format(
                    "OK,Bought %d apples; apples now=%d, oranges=%d",
                    number, apples, oranges
            );
        } finally {
            releaseLock();
        }
    }

    public String buyOranges(int number) {
        acquireLock();
        try {
            if (number <= 0) {
                return "ERROR,Buy_oranges value must be positive";
            }
            if (number > oranges) {
                return String.format("ERROR,Not enough oranges in stock (have %d)", oranges);
            }
            oranges -= number;
            return String.format(
                    "OK,Bought %d oranges; apples now=%d, oranges=%d",
                    number, apples, oranges
            );
        } finally {
            releaseLock();
        }
    }

    public String addApples(int number) {
        acquireLock();
        try {
            if (number <= 0) {
                return "ERROR,Add_apples value must be positive";
            }
            apples += number;
            return String.format(
                    "OK,Added %d apples; apples now=%d, oranges=%d",
                    number, apples, oranges
            );
        } finally {
            releaseLock();
        }
    }

    public String addOranges(int number) {
        acquireLock();
        try {
            if (number <= 0) {
                return "ERROR,Add_oranges value must be positive";
            }
            oranges += number;
            return String.format(
                    "OK,Added %d oranges; apples now=%d, oranges=%d",
                    number, apples, oranges
            );
        } finally {
            releaseLock();
        }
    }
}
